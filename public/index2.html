<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Volná místa – denní build (MPSV)</title>
  <style>
    /* ZACHOVÁNÍ LOOK&FEEL: jednoduché styly, žádná změna barevného schématu,
       vše v neutrálních odstínech, rozložení jako dřív: nadpis, 3 "pills",
       statistiky, top zaměstnavatelé, tabulka nabídek. */

    :root { --muted:#666; --border:#e4e4e7; }

    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; margin:20px;}
    header{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:8px 0 16px}
    .pill{padding:8px 12px; border:1px solid #ccc; border-radius:999px; cursor:pointer; user-select:none}
    .pill.active{background:#111; color:#fff; border-color:#111}
    .stats{display:flex; gap:24px; margin:16px 0; flex-wrap:wrap}
    .card{border:1px solid var(--border); border-radius:12px; padding:16px}
    table{border-collapse:collapse; width:100%}
    th,td{border-bottom:1px solid #eee; padding:8px 6px; text-align:left; font-size:14px}
    th{background:#fafafa}
    .muted{color:var(--muted)}
    .updated{font-size:13px; color:var(--muted); margin:6px 0 0}
    .kpi{font-size:28px;font-weight:700}
    @media (max-width:640px){
      .kpi{font-size:22px}
    }
  </style>
</head>
<body>
  <h1 style="margin:0 0 4px">Denní data volných míst (MPSV)</h1>
  <div class="updated">Naposledy aktualizováno: <span id="last-updated">–</span></div>
  <p class="muted" style="margin:8px 0 0">Data z <code>volna-mista.json</code> → automatický denní build přes GitHub Actions.</p>

  <header>
    <span class="pill active" data-tag="auto">Auto</span>
    <span class="pill" data-tag="agri">Agri</span>
    <span class="pill" data-tag="gastro">Gastro</span>
  </header>

  <section class="stats">
    <div class="card"><div class="muted">Počet nabídek</div><div id="count" class="kpi">–</div></div>
    <div class="card"><div class="muted">Medián mzdy (od)</div><div id="median" class="kpi">–</div></div>
  </section>

  <section class="card" style="margin-bottom:16px">
    <h3 style="margin:0 0 8px">Top zaměstnavatelé (TOP 10)</h3>
    <ol id="top" style="margin:0 0 0 18px"></ol>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">Poslední nabídky (max 200)</h3>
    <table>
      <thead>
        <tr>
          <th>Profese</th>
          <th>Zaměstnavatel</th>
          <th>Okres / místo</th>
          <th>Mzda</th>
          <th>Datum</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <script>
    // =============================
    //  Načítání dat a render
    // =============================

    let CURRENT_TAG = 'auto';
    const lastUpdatedEl = document.getElementById('last-updated');
    const countEl = document.getElementById('count');
    const medianEl = document.getElementById('median');
    const topEl = document.getElementById('top');
    const rowsEl = document.getElementById('rows');

    async function fetchJSON(url){
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + '_=' + Date.now());
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    // Načte JSON dané kategorie + nastaví "Naposledy aktualizováno" podle built_at.
    async function loadAndRender(tag){
      const data = await fetchJSON(`data/${tag}.json`);
      render(tag, data);

      // Zkuste vzít built_at z právě načtené kategorie; pokud není, fallback – načti auto.json
      const builtAt = data?.summary?.built_at;
      if (builtAt) {
        lastUpdatedEl.textContent = new Date(builtAt).toLocaleString('cs-CZ');
      } else if (tag !== 'auto') {
        try {
          const autoData = await fetchJSON('data/auto.json');
          const builtAtAuto = autoData?.summary?.built_at;
          lastUpdatedEl.textContent = builtAtAuto
            ? new Date(builtAtAuto).toLocaleString('cs-CZ')
            : '–';
        } catch {
          lastUpdatedEl.textContent = '–';
        }
      } else {
        lastUpdatedEl.textContent = '–';
      }
    }

    function render(tag, data){
      // aktivní pill
      document.querySelectorAll('.pill').forEach(p => {
        p.classList.toggle('active', p.dataset.tag === tag);
      });

      // KPI
      countEl.textContent = data?.summary?.count ?? '–';
      medianEl.textContent = (data?.summary?.median_wage_low ?? '–');

      // Top zaměstnavatelé
      topEl.innerHTML = '';
      (data?.top_employers || []).forEach(e => {
        const li = document.createElement('li');
        li.textContent = `${e.name} (${e.count})`;
        topEl.appendChild(li);
      });

      // Poslední nabídky
      rowsEl.innerHTML = '';
      (data?.last_offers || []).forEach(r => {
        const mzda = (r.mzda_od ?? '') + (r.mzda_do ? '–' + r.mzda_do : '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.profese || '')}</td>
          <td>${escapeHtml(r.zamestnavatel || '')}</td>
          <td>${escapeHtml(r.okres || '')}</td>
          <td>${escapeHtml(mzda || '')}</td>
          <td>${escapeHtml(r.datum || '')}</td>
        `;
        rowsEl.appendChild(tr);
      });
    }

    // Malá utilita – bezpečný text do HTML
    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    // Kliky na "pills"
    document.querySelectorAll('.pill').forEach(el => {
      el.addEventListener('click', async () => {
        CURRENT_TAG = el.dataset.tag;
        try {
          await loadAndRender(CURRENT_TAG);
        } catch (e) {
          console.warn('Data load failed for', CURRENT_TAG, e);
        }
      });
    });

    // Init – nejdřív zkus "auto"
    (async function init(){
      try {
        await loadAndRender(CURRENT_TAG);
      } catch (e) {
        // Když auto selže, zkusíme další kategorie (pro případ, že se vytvořil jen jeden JSON)
        for (const tag of ['agri', 'gastro']) {
          try {
            await loadAndRender(tag);
            CURRENT_TAG = tag;
            break;
          } catch {}
        }
      }
    })();
  </script>
</body>
</html>
